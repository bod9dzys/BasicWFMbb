{% extends "base.html" %}
{% load crispy_forms_tags %}

{% block title %}Обмін змін{% endblock %}

{% block content %}
<h2 class="h4 mb-3">Запит на обмін</h2>
<form method="post" class="card" id="exchange-form"> {# Додано ID форми #}
  <div class="card-body">
    {% csrf_token %}
    {% crispy form %}
  </div>
</form>

<script>
document.addEventListener('DOMContentLoaded', function () {
  const shiftsUrl = "{% url 'ajax_get_agent_shifts' %}";
  const fromAgentSelect = document.getElementById('id_from_agent');
  const toAgentSelect = document.getElementById('id_to_agent');
  const fromShiftSelect = document.getElementById('id_from_shift');
  const toShiftSelect = document.getElementById('id_to_shift');

  const DEFAULT_PLACEHOLDER = 'Оберіть зміну';

  function placeholderOption(text) {
    const option = document.createElement('option');
    option.value = '';
    option.textContent = text;
    return option;
  }

  function setInitialState(shiftSelect, message) {
    const label = shiftSelect.dataset.placeholder || DEFAULT_PLACEHOLDER;
    shiftSelect.innerHTML = '';
    shiftSelect.appendChild(placeholderOption(message || label));
    shiftSelect.disabled = true;
  }

  async function updateShifts(agentSelect, shiftSelect) {
    if (!agentSelect || !shiftSelect) {
      return;
    }

    const agentId = agentSelect.value;
    const placeholder = shiftSelect.dataset.placeholder || DEFAULT_PLACEHOLDER;
    const previouslySelected = shiftSelect.dataset.selected || '';

    if (!agentId) {
      setInitialState(shiftSelect);
      return;
    }

    shiftSelect.disabled = true;
    shiftSelect.innerHTML = '';
    shiftSelect.appendChild(placeholderOption('Завантаження...'));

    try {
      const response = await fetch(`${shiftsUrl}?agent_id=${encodeURIComponent(agentId)}`, {
        credentials: 'same-origin'
      });
      if (!response.ok) {
        throw new Error(`HTTP ${response.status}`);
      }
      const data = await response.json();

      shiftSelect.innerHTML = '';
      shiftSelect.appendChild(placeholderOption(placeholder));

      if (data.error) {
        console.error('Помилка сервера:', data.error);
        const errorOption = placeholderOption(data.error);
        errorOption.disabled = true;
        shiftSelect.appendChild(errorOption);
      } else if (data.shifts && data.shifts.length) {
        data.shifts.forEach((shift) => {
          const option = document.createElement('option');
          option.value = shift.id;
          option.textContent = shift.text;
          shiftSelect.appendChild(option);
        });
      } else {
        const emptyOption = placeholderOption('Змін не знайдено');
        emptyOption.disabled = true;
        shiftSelect.appendChild(emptyOption);
      }

      if (previouslySelected) {
        shiftSelect.value = previouslySelected;
        if (shiftSelect.value !== previouslySelected) {
          // Якщо попередній вибір відсутній у новому списку
          shiftSelect.dataset.selected = '';
        }
      }
    } catch (error) {
      console.error('Помилка завантаження змін:', error);
      shiftSelect.innerHTML = '';
      shiftSelect.appendChild(placeholderOption(placeholder));
      const errorOption = placeholderOption(`Помилка завантаження: ${error.message || 'невідомо'}`);
      errorOption.disabled = true;
      shiftSelect.appendChild(errorOption);
    } finally {
      shiftSelect.disabled = false;
    }
  }

  function attachHandlers(agentSelect, shiftSelect) {
    if (!agentSelect || !shiftSelect) {
      return;
    }

    agentSelect.addEventListener('change', function () {
      shiftSelect.dataset.selected = '';
      updateShifts(agentSelect, shiftSelect);
    });

    shiftSelect.addEventListener('change', function () {
      shiftSelect.dataset.selected = this.value;
    });

    if (agentSelect.value) {
      updateShifts(agentSelect, shiftSelect);
    } else {
      setInitialState(shiftSelect, 'Спочатку оберіть агента');
    }
  }

  attachHandlers(fromAgentSelect, fromShiftSelect);
  attachHandlers(toAgentSelect, toShiftSelect);
});
</script>
{% endblock %}
