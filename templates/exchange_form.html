{% extends "base.html" %}
{% load crispy_forms_tags %}

{% block title %}Обмін змін{% endblock %}

{% block content %}
<style>
  .exchange-badge {
    display: inline-flex;
    align-items: center;
    padding: 0.25rem 0.75rem;
    border-radius: 999px;
    background: rgba(76, 201, 240, 0.2);
    color: #0f172a;
    font-weight: 600;
    font-size: 0.78rem;
    letter-spacing: 0.04em;
    text-transform: uppercase;
  }
  .exchange-help {
    color: var(--text-secondary);
    margin: 0;
    font-size: 0.88rem;
  }
  .exchange-form__body {
    padding: 2rem 2.5rem;
  }
  @media (max-width: 767.98px) {
    .exchange-form__body {
      padding: 1.75rem;
    }
  }
</style>

<form method="post" class="form-card glass-card" id="exchange-form">
  <div class="form-card__header d-flex flex-column flex-md-row align-items-md-center justify-content-between gap-3">
    <div>
      <span class="exchange-badge mb-2">Обмін</span>
      <h1 class="form-card__title mb-1">Запит на обмін змінами</h1>
      <p class="form-card__subtitle exchange-help">
        Оберіть двох агентів, перевірте доступні зміни та підтвердьте, щоб виконати взаємний обмін.
      </p>
    </div>
    <div class="text-muted text-md-end small">
      Крок 1 · Підбір змін
    </div>
  </div>
  <div class="exchange-form__body">
    {% csrf_token %}
    {% crispy form %}
  </div>
</form>

<script>
document.addEventListener('DOMContentLoaded', function () {
  const shiftsUrl = "{% url 'ajax_get_agent_shifts' %}";
  const fromAgentSelect = document.getElementById('id_from_agent');
  const toAgentSelect = document.getElementById('id_to_agent');
  const fromShiftSelect = document.getElementById('id_from_shift');
  const toShiftSelect = document.getElementById('id_to_shift');

  const DEFAULT_PLACEHOLDER = 'Оберіть зміну';

  function ensureBasePlaceholder(selectEl) {
    if (!selectEl) {
      return DEFAULT_PLACEHOLDER;
    }
    if (!selectEl.dataset.basePlaceholder) {
      const firstOption = selectEl.options && selectEl.options.length ? selectEl.options[0] : null;
      const candidate =
        selectEl.dataset.placeholder ||
        selectEl.getAttribute('placeholder') ||
        (firstOption && !firstOption.value && firstOption.textContent.trim()
          ? firstOption.textContent.trim()
          : DEFAULT_PLACEHOLDER);
      selectEl.dataset.basePlaceholder = candidate || DEFAULT_PLACEHOLDER;
    }
    return selectEl.dataset.basePlaceholder;
  }

  function applyPlaceholderToTomSelect(ts, placeholderText) {
    if (!ts) {
      return;
    }
    ts.settings.placeholder = placeholderText;
    if (typeof ts.updatePlaceholder === 'function') {
      ts.updatePlaceholder();
    } else if (ts.control_input) {
      ts.control_input.setAttribute('placeholder', placeholderText);
    }
  }

  function resetSelect(selectEl, placeholderOverride, disable = true) {
    if (!selectEl) {
      return;
    }
    const basePlaceholder = ensureBasePlaceholder(selectEl);
    const placeholderText = placeholderOverride || basePlaceholder;
    const ts = selectEl.tomselect || null;

    if (ts) {
      ts.clear(true);
      ts.clearOptions();
      ts.addOption({ value: '', text: placeholderText });
      ts.refreshOptions(false);
      if (selectEl.multiple) {
        ts.setValue([], true);
      } else {
        ts.setValue('', true);
      }
      applyPlaceholderToTomSelect(ts, placeholderText);
      if (disable) {
        ts.disable();
      } else {
        ts.enable();
      }
    } else {
      selectEl.innerHTML = '';
      const option = document.createElement('option');
      option.value = '';
      option.textContent = placeholderText;
      selectEl.appendChild(option);
      selectEl.value = '';
      selectEl.disabled = disable;
    }
    selectEl.disabled = disable;
  }

  function populateSelect(selectEl, options, selectedValue) {
    if (!selectEl) {
      return;
    }
    const basePlaceholder = ensureBasePlaceholder(selectEl);
    const ts = selectEl.tomselect || null;
    const normalizedOptions = options.map((opt) => ({
      value: String(opt.value),
      text: opt.text,
    }));

    if (ts) {
      ts.clear(true);
      ts.clearOptions();
      ts.addOption({ value: '', text: basePlaceholder });
      normalizedOptions.forEach((opt) => ts.addOption(opt));
      ts.refreshOptions(false);
      const normalizedSelected = selectedValue != null ? String(selectedValue) : '';
      const hasSelected =
        normalizedSelected &&
        normalizedOptions.some((opt) => opt.value === normalizedSelected);
      if (selectEl.multiple) {
        ts.setValue(hasSelected ? [normalizedSelected] : [], true);
      } else {
        ts.setValue(hasSelected ? normalizedSelected : '', true);
      }
      applyPlaceholderToTomSelect(ts, basePlaceholder);
      ts.enable();
    } else {
      selectEl.innerHTML = '';
      const placeholderOption = document.createElement('option');
      placeholderOption.value = '';
      placeholderOption.textContent = basePlaceholder;
      selectEl.appendChild(placeholderOption);
      normalizedOptions.forEach((opt) => {
        const option = document.createElement('option');
        option.value = opt.value;
        option.textContent = opt.text;
        selectEl.appendChild(option);
      });
      const hasSelected =
        selectedValue &&
        normalizedOptions.some((opt) => opt.value === String(selectedValue));
      selectEl.value = hasSelected ? String(selectedValue) : '';
      selectEl.disabled = false;
    }
    selectEl.disabled = false;
  }

  async function updateShifts(agentSelect, shiftSelect) {
    if (!agentSelect || !shiftSelect) {
      return;
    }

    const agentId = agentSelect.value;
    const previouslySelected = shiftSelect.dataset.selected || '';

    if (!agentId) {
      resetSelect(shiftSelect, 'Спочатку оберіть агента');
      return;
    }

    resetSelect(shiftSelect, 'Завантаження...');

    try {
      const response = await fetch(`${shiftsUrl}?agent_id=${encodeURIComponent(agentId)}`, {
        credentials: 'same-origin'
      });
      if (!response.ok) {
        throw new Error(`HTTP ${response.status}`);
      }
      const data = await response.json();

      if (data.error) {
        console.error('Помилка сервера:', data.error);
        resetSelect(shiftSelect, data.error);
      } else if (data.shifts && data.shifts.length) {
        populateSelect(
          shiftSelect,
          data.shifts.map((shift) => ({
            value: shift.id,
            text: shift.text,
          })),
          previouslySelected
        );
      } else {
        resetSelect(shiftSelect, 'Змін не знайдено');
      }

      if (previouslySelected) {
        const ts = shiftSelect.tomselect || null;
        if (ts) {
          const items = Array.isArray(ts.items) ? ts.items : [];
          if (!items.includes(String(previouslySelected))) {
            shiftSelect.dataset.selected = '';
          }
        } else if (shiftSelect.value !== String(previouslySelected)) {
          shiftSelect.dataset.selected = '';
        }
      }
    } catch (error) {
      console.error('Помилка завантаження змін:', error);
      resetSelect(
        shiftSelect,
        `Помилка завантаження: ${error.message || 'невідомо'}`
      );
    }
  }

  function attachHandlers(agentSelect, shiftSelect) {
    if (!agentSelect || !shiftSelect) {
      return;
    }

    agentSelect.addEventListener('change', function () {
      shiftSelect.dataset.selected = '';
      updateShifts(agentSelect, shiftSelect);
    });

    shiftSelect.addEventListener('change', function () {
      shiftSelect.dataset.selected = this.value;
    });

    if (agentSelect.value) {
      updateShifts(agentSelect, shiftSelect);
    } else {
      resetSelect(shiftSelect, 'Спочатку оберіть агента');
    }
  }

  attachHandlers(fromAgentSelect, fromShiftSelect);
  attachHandlers(toAgentSelect, toShiftSelect);
});
</script>
{% endblock %}
