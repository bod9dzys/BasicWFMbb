{% extends "base.html" %}
{% load crispy_forms_tags %}

{% block title %}Обмін змін{% endblock %}

{% block content %}
<style>
  .exchange-badge {
    display: inline-flex;
    align-items: center;
    padding: 0.25rem 0.75rem;
    border-radius: 999px;
    background: rgba(76, 201, 240, 0.2);
    color: #0f172a;
    font-weight: 600;
    font-size: 0.78rem;
    letter-spacing: 0.04em;
    text-transform: uppercase;
  }
  .exchange-help {
    color: var(--text-secondary);
    margin: 0;
    font-size: 0.88rem;
  }
  .exchange-form__body {
    padding: 2rem 2.5rem;
  }
  @media (max-width: 767.98px) {
    .exchange-form__body {
      padding: 1.75rem;
    }
  }
</style>

<form method="post" class="form-card glass-card" id="exchange-form">
  <div class="form-card__header d-flex flex-column flex-md-row align-items-md-center justify-content-between gap-3">
    <div>
      <span class="exchange-badge mb-2">Обмін</span>
      <h1 class="form-card__title mb-1">Запит на обмін змінами</h1>
      <p class="form-card__subtitle exchange-help">
        Оберіть двох агентів, перевірте доступні зміни та підтвердьте, щоб виконати взаємний обмін.
      </p>
    </div>
    <div class="text-muted text-md-end small">
      Крок 1 · Підбір змін
    </div>
  </div>
  <div class="exchange-form__body">
    {% csrf_token %}
    {% crispy form %}
  </div>
</form>

<script>
document.addEventListener('DOMContentLoaded', function () {
  const shiftsUrl = "{% url 'ajax_get_agent_shifts' %}";
  const fromAgentSelect = document.getElementById('id_from_agent');
  const toAgentSelect = document.getElementById('id_to_agent');
  const fromShiftSelect = document.getElementById('id_from_shift');
  const toShiftSelect = document.getElementById('id_to_shift');

  const DEFAULT_PLACEHOLDER = 'Оберіть зміну';

  function placeholderOption(text) {
    const option = document.createElement('option');
    option.value = '';
    option.textContent = text;
    return option;
  }

  function setInitialState(shiftSelect, message) {
    const label = shiftSelect.dataset.placeholder || DEFAULT_PLACEHOLDER;
    shiftSelect.innerHTML = '';
    shiftSelect.appendChild(placeholderOption(message || label));
    shiftSelect.disabled = true;
  }

  async function updateShifts(agentSelect, shiftSelect) {
    if (!agentSelect || !shiftSelect) {
      return;
    }

    const agentId = agentSelect.value;
    const placeholder = shiftSelect.dataset.placeholder || DEFAULT_PLACEHOLDER;
    const previouslySelected = shiftSelect.dataset.selected || '';

    if (!agentId) {
      setInitialState(shiftSelect);
      return;
    }

    shiftSelect.disabled = true;
    shiftSelect.innerHTML = '';
    shiftSelect.appendChild(placeholderOption('Завантаження...'));

    try {
      const response = await fetch(`${shiftsUrl}?agent_id=${encodeURIComponent(agentId)}`, {
        credentials: 'same-origin'
      });
      if (!response.ok) {
        throw new Error(`HTTP ${response.status}`);
      }
      const data = await response.json();

      shiftSelect.innerHTML = '';
      shiftSelect.appendChild(placeholderOption(placeholder));

      if (data.error) {
        console.error('Помилка сервера:', data.error);
        const errorOption = placeholderOption(data.error);
        errorOption.disabled = true;
        shiftSelect.appendChild(errorOption);
      } else if (data.shifts && data.shifts.length) {
        data.shifts.forEach((shift) => {
          const option = document.createElement('option');
          option.value = shift.id;
          option.textContent = shift.text;
          shiftSelect.appendChild(option);
        });
      } else {
        const emptyOption = placeholderOption('Змін не знайдено');
        emptyOption.disabled = true;
        shiftSelect.appendChild(emptyOption);
      }

      if (previouslySelected) {
        shiftSelect.value = previouslySelected;
        if (shiftSelect.value !== previouslySelected) {
          // Якщо попередній вибір відсутній у новому списку
          shiftSelect.dataset.selected = '';
        }
      }
    } catch (error) {
      console.error('Помилка завантаження змін:', error);
      shiftSelect.innerHTML = '';
      shiftSelect.appendChild(placeholderOption(placeholder));
      const errorOption = placeholderOption(`Помилка завантаження: ${error.message || 'невідомо'}`);
      errorOption.disabled = true;
      shiftSelect.appendChild(errorOption);
    } finally {
      shiftSelect.disabled = false;
    }
  }

  function attachHandlers(agentSelect, shiftSelect) {
    if (!agentSelect || !shiftSelect) {
      return;
    }

    agentSelect.addEventListener('change', function () {
      shiftSelect.dataset.selected = '';
      updateShifts(agentSelect, shiftSelect);
    });

    shiftSelect.addEventListener('change', function () {
      shiftSelect.dataset.selected = this.value;
    });

    if (agentSelect.value) {
      updateShifts(agentSelect, shiftSelect);
    } else {
      setInitialState(shiftSelect, 'Спочатку оберіть агента');
    }
  }

  attachHandlers(fromAgentSelect, fromShiftSelect);
  attachHandlers(toAgentSelect, toShiftSelect);
});
</script>
{% endblock %}
