{% extends "base.html" %}
{% load crispy_forms_tags %}

{% block title %}Обмін змін{% endblock %}

{% block content %}
<h2 class="h4 mb-3">Запит на обмін</h2>
<form method="post" class="card" id="exchange-form"> {# Додано ID форми #}
  <div class="card-body">
    {% csrf_token %}
    {% crispy form %}
  </div>
</form>

{# --- ДОДАНО JAVASCRIPT --- #}
<script>
  document.addEventListener('DOMContentLoaded', function() {
    const fromAgentSelect = document.getElementById('id_from_agent');
    const toAgentSelect = document.getElementById('id_to_agent');
    const fromShiftSelect = document.getElementById('id_from_shift');
    const toShiftSelect = document.getElementById('id_to_shift');
    // URL для AJAX запиту (переконайтесь, що ім'я 'ajax_get_agent_shifts' правильне)
    const shiftsUrl = "{% url 'ajax_get_agent_shifts' %}";

    function updateShifts(agentSelectElement, shiftSelectElement) {
      const agentId = agentSelectElement.value;
      // Очищаємо список змін
      shiftSelectElement.innerHTML = '<option value="">---------</option>';

      if (agentId) {
        fetch(`${shiftsUrl}?agent_id=${agentId}`)
          .then(response => response.json())
          .then(data => {
            if (data.shifts && data.shifts.length > 0) {
              data.shifts.forEach(shift => {
                const option = document.createElement('option');
                option.value = shift.id;
                option.textContent = shift.text;
                shiftSelectElement.appendChild(option);
              });
            } else {
               // Можна додати опцію "Немає доступних змін"
               const option = document.createElement('option');
               option.value = "";
               option.textContent = "Немає змін для обміну у цьому місяці";
               option.disabled = true;
               shiftSelectElement.appendChild(option);
            }
          })
          .catch(error => {
            console.error('Помилка завантаження змін:', error);
             const option = document.createElement('option');
             option.value = "";
             option.textContent = "Помилка завантаження змін";
             option.disabled = true;
             shiftSelectElement.appendChild(option);
          });
      }
    }

    // Додаємо слухачів подій
    if (fromAgentSelect) {
        fromAgentSelect.addEventListener('change', function() {
            updateShifts(this, fromShiftSelect);
        });
         // Запускаємо оновлення при завантаженні, якщо агент вже вибраний (наприклад, для поточного користувача)
        if (fromAgentSelect.value) {
             updateShifts(fromAgentSelect, fromShiftSelect);
        }
    }
    if (toAgentSelect) {
        toAgentSelect.addEventListener('change', function() {
            updateShifts(this, toShiftSelect);
        });
         // Запускаємо оновлення при завантаженні, якщо агент вже вибраний (рідко, але можливо)
         if (toAgentSelect.value) {
             updateShifts(toAgentSelect, toShiftSelect);
        }
    }

  });
</script>
{# --- КІНЕЦЬ JAVASCRIPT --- #}
{% endblock %}