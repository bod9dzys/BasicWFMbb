{% extends "base.html" %}
{% load crispy_forms_tags %}

{% block title %}Обмін змін{% endblock %}

{% block content %}
<h2 class="h4 mb-3">Запит на обмін</h2>
<form method="post" class="card">
  <div class="card-body">
    {% csrf_token %}
    {% crispy form %}
  </div>
</form>

{{ agent_shifts_json|json_script:"agent-shifts-data" }}
<script>
document.addEventListener("DOMContentLoaded", function () {
  const dataElement = document.getElementById("agent-shifts-data");
  if (!dataElement) {
    return;
  }
  const agentShifts = JSON.parse(dataElement.textContent || "{}");
  const fromAgentSelect = document.getElementById("id_from_agent");
  const fromShiftSelect = document.getElementById("id_from_shift");
  const toAgentSelect = document.getElementById("id_to_agent");
  const toShiftSelect = document.getElementById("id_to_shift");

  function rebuildOptions(shiftSelect, agentId) {
    if (!shiftSelect) {
      return;
    }
    const placeholder = shiftSelect.dataset.placeholder || "Оберіть зміну";
    const selectedValue = shiftSelect.dataset.selected || "";
    const options = agentShifts[agentId] || [];

    shiftSelect.innerHTML = "";
    const placeholderOption = document.createElement("option");
    placeholderOption.value = "";
    placeholderOption.textContent = placeholder;
    shiftSelect.appendChild(placeholderOption);

    options.forEach(function (item) {
      const option = document.createElement("option");
      option.value = item.id;
      option.textContent = item.label;
      if (String(item.id) === String(selectedValue)) {
        option.selected = true;
      }
      shiftSelect.appendChild(option);
    });

    shiftSelect.dataset.selected = shiftSelect.value;
  }

  if (fromAgentSelect && fromShiftSelect) {
    rebuildOptions(fromShiftSelect, fromAgentSelect.value);
    fromAgentSelect.addEventListener("change", function () {
      fromShiftSelect.dataset.selected = "";
      rebuildOptions(fromShiftSelect, this.value);
    });
    fromShiftSelect.addEventListener("change", function () {
      this.dataset.selected = this.value;
    });
  }

  if (toAgentSelect && toShiftSelect) {
    rebuildOptions(toShiftSelect, toAgentSelect.value);
    toAgentSelect.addEventListener("change", function () {
      toShiftSelect.dataset.selected = "";
      rebuildOptions(toShiftSelect, this.value);
    });
    toShiftSelect.addEventListener("change", function () {
      this.dataset.selected = this.value;
    });
  }
});
</script>
{% endblock %}
