{% extends "base.html" %}
{% load crispy_forms_tags %}

{% block title %}Інструменти{% endblock %}

{% block content %}
<style>
  .tools-wrapper {
    display: grid;
    gap: 1.75rem;
  }
  .tools-card__header {
    padding: 2rem 2.5rem 1.25rem;
  }
  .tools-card__body {
    padding: 0 2.5rem 2.25rem;
    overflow: visible;
  }
  .tools-wrapper .form-card.glass-card {
    overflow: visible;
  }
  .tools-badge {
    display: inline-flex;
    align-items: center;
    padding: 0.25rem 0.75rem;
    border-radius: 999px;
    background: rgba(76, 201, 240, 0.2);
    color: #0f172a;
    font-weight: 600;
    font-size: 0.78rem;
    letter-spacing: 0.04em;
    text-transform: uppercase;
  }
  .tools-summary {
    display: grid;
    gap: 0.75rem;
  }
  .summary-metric {
    background: rgba(76, 201, 240, 0.14);
    border-radius: 1rem;
    padding: 1rem 1.25rem;
    border: 1px solid rgba(76, 201, 240, 0.22);
    display: flex;
    flex-direction: column;
    gap: 0.35rem;
  }
  .summary-metric__label {
    font-size: 0.78rem;
    letter-spacing: 0.08em;
    text-transform: uppercase;
    color: rgba(15, 23, 42, 0.56);
  }
  .summary-metric__value {
    font-size: 1.65rem;
    font-weight: 600;
    color: #0f172a;
  }
  .results-table-wrapper {
    border-radius: 1.2rem;
    background: rgba(255, 255, 255, 0.88);
    border: 1px solid rgba(148, 163, 184, 0.18);
    box-shadow: 0 20px 45px rgba(15, 23, 42, 0.1);
    overflow: hidden;
  }
  .results-table thead th {
    background: rgba(15, 23, 42, 0.035);
    font-size: 0.75rem;
    text-transform: uppercase;
    letter-spacing: 0.05em;
  }
  .results-table tbody td {
    vertical-align: middle;
  }
.tools-card__body .ts-wrapper {
    width: 100%;
  }
  .tools-card__body .ts-control {
    min-height: 56px;
    border-radius: 1rem;
    border: 1px solid rgba(148, 163, 184, 0.3);
    padding: 0.75rem 1rem;
    font-size: 1rem;
    background: rgba(255, 255, 255, 0.98);
    box-shadow: inset 0 1px 3px rgba(15, 23, 42, 0.04);
  }
  .tools-card__body .ts-control input {
    font-size: 1rem;
  }
  .tools-card__body .ts-control.focus {
    border-color: #4895ef;
    box-shadow: 0 0 0 0.25rem rgba(72, 149, 239, 0.25);
    background: #fff;
  }
  .tools-card__body .ts-dropdown {
    max-height: 320px;
    border-radius: 1rem;
    border: 1px solid rgba(148, 163, 184, 0.25);
    box-shadow: 0 18px 36px rgba(15, 23, 42, 0.12);
  }
  .tools-card__body .ts-dropdown .option {
    padding: 0.75rem 0.9rem;
    font-size: 0.98rem;
    border-radius: 0.85rem;
  }
  @media (max-width: 767.98px) {
    .tools-card__header,
    .tools-card__body {
      padding: 1.5rem;
    }
    .summary-metric__value {
      font-size: 1.35rem;
    }
  }
</style>

<div class="tools-wrapper">
  <div class="form-card glass-card">
    <div class="tools-card__header d-flex flex-column flex-lg-row justify-content-between gap-3">
      <div>
        <span class="tools-badge mb-2">Інструменти</span>
        <h1 class="form-card__title mb-2">Аналіз робочих годин</h1>
        <p class="form-card__subtitle mb-0">
          Оберіть період та за потреби відфільтруйте за тімлідом, конкретним агентом або напрямком, щоб побачити відпрацьовані години.
        </p>
      </div>
    </div>
    <div class="tools-card__body">
      <form method="get" class="row g-3 align-items-end">
        {{ form.non_field_errors }}
        <div class="col-sm-6 col-md-6 col-lg-3">
          {{ form.team_lead|as_crispy_field }}
        </div>
        <div class="col-sm-6 col-md-6 col-lg-3">
          {{ form.agent|as_crispy_field }}
        </div>
        <div class="col-sm-6 col-md-6 col-lg-3">
          {{ form.direction|as_crispy_field }}
        </div>
        <div class="col-sm-6 col-md-6 col-lg-3">
          {{ form.start|as_crispy_field }}
        </div>
        <div class="col-sm-6 col-md-6 col-lg-3">
          {{ form.end|as_crispy_field }}
        </div>
        <div class="col-12 col-md-auto d-flex flex-wrap gap-2">
          <button type="submit" class="btn btn-accent">Розрахувати</button>
          <button type="submit" class="btn btn-soft" name="export" value="1">Експорт XLSX</button>
        </div>
      </form>
    </div>
  </div>

  {% if summary %}
    <div class="tools-card__summary tools-summary">
      <div class="summary-metric">
        <span class="summary-metric__label">
          {% if summary.agent %}Агент{% elif summary.team_lead %}Тімлід{% else %}Результати{% endif %}
        </span>
        <span class="summary-metric__value">
          {% if summary.agent %}
            {{ summary.agent.user.get_full_name|default:summary.agent.user.username }}
          {% elif summary.team_lead %}
            {{ summary.team_lead.get_full_name|default:summary.team_lead.username }}
          {% else %}
            Обрані параметри
          {% endif %}
        </span>
        <span class="text-muted small">{{ summary.start|date:"d.m.Y H:i" }} — {{ summary.end|date:"d.m.Y H:i" }}</span>
        {% if summary.directions %}
          <span class="text-muted small">Напрямки: {{ summary.directions|join:", " }}</span>
        {% endif %}
        {% if summary.total_agents and summary.total_agents > 1 %}
          <span class="text-muted small">Агентів: {{ summary.total_agents }}</span>
        {% endif %}
      </div>
      <div class="d-grid d-md-flex gap-3">
        <div class="summary-metric flex-fill">
          <span class="summary-metric__label">Всього годин</span>
          <span class="summary-metric__value">{{ summary.total_hours }}</span>
        </div>
        <div class="summary-metric flex-fill">
          <span class="summary-metric__label">Кількість змін</span>
          <span class="summary-metric__value">{{ summary.total_shifts }}</span>
        </div>
      </div>
    </div>

    {% if summary.total_agents|default:0 == 0 %}
      <div class="results-table-wrapper">
        <div class="p-4 text-center text-muted">
          За обраними параметрами не знайдено жодного агента.
        </div>
      </div>
    {% endif %}

    {% if agent_summaries and summary.total_agents|default:0 > 1 %}
      <div class="results-table-wrapper">
        <div class="table-responsive">
          <table class="table table-modern results-table mb-0">
            <thead>
              <tr>
                <th scope="col">Агент</th>
                <th scope="col">Години</th>
                <th scope="col">Кількість змін</th>
              </tr>
            </thead>
            <tbody>
              {% for item in agent_summaries %}
                <tr>
                  <td>{{ item.display_name }}</td>
                  <td class="fw-semibold">{{ item.total_hours }}</td>
                  <td>{{ item.total_shifts }}</td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    {% endif %}

    {% if summary.agent %}
      <div class="results-table-wrapper">
        {% if shift_rows %}
          <div class="table-responsive">
            <table class="table table-modern results-table mb-0">
              <thead>
                <tr>
                  <th scope="col">Дата</th>
                  <th scope="col">Години</th>
                  <th scope="col">Напрямок</th>
                  <th scope="col">Статус</th>
                  <th scope="col">Активність</th>
                </tr>
              </thead>
              <tbody>
                {% for row in shift_rows %}
                  <tr>
                    <td>
                      <div class="fw-semibold">{{ row.start|date:"d.m.Y" }}</div>
                      <div class="text-muted small">
                        {{ row.start|date:"H:i" }} – {{ row.end|date:"H:i" }}
                        {% if row.full_start != row.start or row.full_end != row.end %}
                          <span class="text-muted">
                            ({{ row.full_start|date:"d.m H:i" }}–{{ row.full_end|date:"d.m H:i" }})
                          </span>
                        {% endif %}
                      </div>
                    </td>
                    <td class="fw-semibold">
                      {{ row.duration_hours }} год
                      {% if not row.counted %}
                        <div class="text-muted small">не враховується</div>
                      {% endif %}
                    </td>
                    <td>{{ row.direction }}</td>
                    <td>{{ row.status }}</td>
                    <td>{{ row.activity|default:"—" }}</td>
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        {% else %}
          <div class="p-4 text-center text-muted">
            За вибраний період змін не знайдено.
          </div>
        {% endif %}
      </div>
    {% endif %}
  {% elif form.is_bound %}
    <div class="results-table-wrapper">
      <div class="p-4 text-center text-muted">
        За вказаними параметрами нічого не знайдено. Спробуйте змінити діапазон дат.
      </div>
    </div>
  {% endif %}
</div>
{% endblock %}
