{% extends "base.html" %}
{% load crispy_forms_tags %}
{% load schedule_filters %}

{% block title %}Розклад — Тиждень{% endblock %}

{% block content %}
<style>
  .schedule-page {
    --schedule-left-col: 240px;
    display: flex;
    flex-direction: column;
    gap: 1.75rem;
  }
  .schedule-toolbar {
    padding: 2rem 2.25rem;
  }
  .schedule-week-badge {
    display: inline-flex;
    align-items: center;
    gap: 0.4rem;
    padding: 0.3rem 0.8rem;
    border-radius: 999px;
    background: rgba(76, 201, 240, 0.18);
    color: #0f172a;
    font-weight: 600;
    font-size: 0.78rem;
    letter-spacing: 0.05em;
    text-transform: uppercase;
  }
  .schedule-week-title {
    font-size: 1.5rem;
    margin-bottom: 0.35rem;
  }
  .schedule-week-range {
    color: var(--text-secondary);
    margin-bottom: 0;
  }
  .meta-pill {
    display: inline-flex;
    align-items: center;
    gap: 0.4rem;
    padding: 0.35rem 0.75rem;
    border-radius: 999px;
    background: rgba(15, 23, 42, 0.06);
    color: var(--text-secondary);
    font-size: 0.8rem;
    font-weight: 500;
  }
  .week-nav .btn {
    min-width: 134px;
  }
  .week-dropdown .dropdown-menu {
    border-radius: 1rem;
    border: 1px solid rgba(148, 163, 184, 0.22);
    box-shadow: 0 20px 45px rgba(15, 23, 42, 0.12);
    padding: 0.25rem;
  }
  .week-dropdown .dropdown-item {
    border-radius: 0.75rem;
    padding: 0.55rem 0.85rem;
    font-size: 0.85rem;
    color: var(--text-secondary);
    transition: background-color 0.2s ease, color 0.2s ease;
  }
  .week-dropdown .dropdown-item:hover {
    background: rgba(76, 201, 240, 0.16);
    color: var(--text-primary);
  }
  .week-dropdown .dropdown-item.active,
  .week-dropdown .dropdown-item:active {
    background: var(--brand-accent);
    color: #0f172a;
    font-weight: 600;
  }
  .schedule-filter__toggle {
    padding-inline: 1.1rem;
  }
  .filters-card {
    border-radius: 1.2rem;
  }
  .filters-card form {
    padding-top: 0.5rem;
  }
  .schedule-table-wrapper .table-responsive {
    border-radius: 1.2rem;
    overflow-x: auto;
    contain: layout paint;
  }
  .schedule-table {
    width: 100%;
    min-width: 1100px;
    table-layout: fixed;
  }
  .schedule-table thead th:first-child,
  .schedule-table tbody td:first-child {
    width: var(--schedule-left-col);
    max-width: none;
  }
  .schedule-table thead th:not(:first-child),
  .schedule-table tbody td:not(:first-child) {
    width: calc((100% - var(--schedule-left-col)) / 7);
  }
  .schedule-table__day-name {
    display: block;
    font-weight: 700;
    font-size: 0.78rem;
    letter-spacing: 0.04em;
  }
  .schedule-table__day-date {
    display: block;
    font-size: 0.9rem;
    font-weight: 600;
    color: 475569;
    margin-top: 0.1rem;
  }
  .agent-card {
    display: flex;
    flex-direction: column;
    gap: 0.2rem;
  }
  .agent-card__name {
    font-weight: 600;
    font-size: 0.95rem;
    color: var(--text-primary);
  }
  .agent-card__meta {
    font-size: 0.78rem;
    color: var(--text-secondary);
  }
  .shift-cell {
    min-width: 150px;
  }
  .shift-stack {
    display: flex;
    flex-direction: column;
    gap: 0.65rem;
    width: 100%;
    contain: layout paint;
  }
  .shift-card {
    display: flex;
    flex-direction: column;
    gap: 0.25rem;
    padding: 0.7rem 0.75rem;
    border-radius: 1rem;
    border: 1px solid rgba(76, 201, 240, 0.22);
    background: rgba(76, 201, 240, 0.12);
    text-align: left;
    width: 100%;
    will-change: transform;
  }
  .shift-card[data-shift-id] {
    cursor: context-menu;
  }
  .shift-card__direction {
    font-size: 0.82rem;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    font-weight: 600;
    color: var(--text-primary);
  }
  /* Context menu */
  .shift-menu {
    position: fixed;
    z-index: 20000;
    min-width: 220px;
    background: #fff;
    border: 1px solid rgba(148,163,184,0.25);
    border-radius: 0.75rem;
    box-shadow: 0 16px 36px rgba(15,23,42,0.15);
    padding: 0.25rem;
    display: none;
  }
  .shift-menu__item {
    display: block;
    width: 100%;
    text-align: left;
    padding: 0.5rem 0.75rem;
    border: none;
    background: transparent;
    color: var(--text-secondary);
    border-radius: 0.6rem;
  }
  .shift-menu__item:hover {
    background: rgba(76, 201, 240, 0.12);
    color: var(--text-primary);
  }
  .shift-card__time {
    font-size: 0.9rem;
    font-weight: 600;
    color: #0f172a;
  }
  .shift-card__meta {
    font-size: 0.76rem;
    color: var(--text-secondary);
  }
  .shift-card--status {
    align-items: center;
    justify-content: center;
    background: rgba(239, 68, 68, 0.12);
    border-color: rgba(239, 68, 68, 0.22);
    color: #b91c1c;
    text-transform: uppercase;
    font-weight: 700;
    font-size: 0.82rem;
  }
  .shift-card--other {
    background: rgba(129, 140, 248, 0.16);
    border-color: rgba(99, 102, 241, 0.28);
  }
  .shift-empty {
    border-radius: 1rem;
    border: 1px dashed rgba(148, 163, 184, 0.4);
    color: rgba(100, 116, 139, 0.9);
    font-size: 0.78rem;
    min-height: 64px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: rgba(255, 255, 255, 0.6);
    letter-spacing: 0.04em;
    text-transform: uppercase;
    width: 100%;
  }
  .pagination {
    margin-bottom: 0;
  }
  .pagination .page-link {
    border-radius: 0.75rem;
    border: 1px solid rgba(148, 163, 184, 0.22);
    color: var(--text-secondary);
    padding: 0.5rem 0.75rem;
    margin: 0 0.25rem;
    transition: all 0.2s ease;
  }
  .pagination .page-link:hover {
    background: rgba(76, 201, 240, 0.16);
    color: var(--text-primary);
    border-color: rgba(76, 201, 240, 0.3);
  }
  .pagination .page-item.active .page-link {
    background: var(--brand-accent);
    color: #0f172a;
    border-color: var(--brand-accent);
    font-weight: 600;
  }
  .pagination .page-item.disabled .page-link {
    opacity: 0.5;
    cursor: not-allowed;
    background: transparent;
  }
  @media (max-width: 1199.98px) {
    .schedule-toolbar {
      padding: 1.75rem;
    }
  }
  @media (max-width: 991.98px) {
    .schedule-toolbar {
      padding: 1.5rem;
    }
    .week-nav .btn {
      min-width: 120px;
    }
  }
  @media (max-width: 767.98px) {
    .schedule-week-title {
      font-size: 1.3rem;
    }
    .schedule-week-badge {
      font-size: 0.7rem;
    }
    .meta-pill {
      font-size: 0.72rem;
    }
  }
</style>

<div class="schedule-page">
  <div class="schedule-toolbar glass-card card">
    <div class="d-flex flex-column flex-lg-row align-items-lg-center justify-content-between gap-4">
      <div>
        <div class="schedule-week-badge">
          Поточний тиждень
        </div>
        <h1 class="schedule-week-title">Розклад на {{ week_start|date:"d.m" }} – {{ days.6|date:"d.m.Y" }}</h1>
        <p class="schedule-week-range">Планування змін з {{ week_start|date:"l, d.m" }} по {{ days.6|date:"l, d.m" }}</p>
        <div class="d-flex flex-wrap gap-2 mt-3">
          <span class="meta-pill">Агентів: {{ table|length }}</span>
          {% if debug_info %}
          <div style="background: #f0f0f0; padding: 10px; margin-top: 10px; font-size: 0.85em; border-radius: 4px;">
            <strong>Профілювання:</strong><br>
            Загальний час: {{ debug_info.timings.total|floatformat:3 }}с<br>
            Кеш: {{ debug_info.timings.cache_check|floatformat:3 }}с<br>
            Запит змін: {{ debug_info.timings.shifts_query|floatformat:3 }}с ({{ debug_info.timings.shifts_count }} змін)<br>
            Обробка змін: {{ debug_info.timings.shifts_processing|floatformat:3 }}с<br>
            Запит агентів: {{ debug_info.timings.agents_query|floatformat:3 }}с<br>
            Побудова таблиці: {{ debug_info.timings.table_build|floatformat:3 }}с<br>
            {% if debug_info.timings.sql_queries %}
            SQL запитів: {{ debug_info.timings.sql_queries }}, час: {{ debug_info.timings.sql_time|floatformat:3 }}с<br>
            {% endif %}
            Агентів всього: {{ debug_info.total_agents }}, показано: {{ debug_info.agents_shown }}<br>
            Змін оброблено: {{ debug_info.shifts_processed }}
          </div>
          {% endif %}
          <span class="meta-pill">Днів: {{ days|length }}</span>
        </div>
      </div>
      <div class="d-flex flex-column align-items-stretch align-items-lg-end gap-3">
        <div class="btn-group week-nav" role="group" aria-label="Навігація тижнями">
          <a class="btn btn-soft" href="{% url 'schedule_week' %}?week={{ prev_week }}{% if show_all %}&show_all=1{% endif %}">‹ Попередній</a>
          <div class="dropdown week-dropdown">
            <button class="btn btn-soft dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">
              Тиждень: {{ week_start|date:"d.m" }} – {{ days.6|date:"d.m.Y" }}
            </button>
            <div id="weeksDropdown" class="dropdown-menu p-0" style="max-height: 320px; overflow: auto; min-width: 320px;">
              {% for w in weeks %}
                <a class="dropdown-item {% if forloop.counter0 == active_week_idx %}active{% endif %}"
                   href="{% url 'schedule_week' %}?week={{ w.param }}{% if show_all %}&show_all=1{% endif %}">
                  {{ w.label }}
                </a>
              {% endfor %}
            </div>
          </div>
          <a class="btn btn-soft" href="{% url 'schedule_week' %}?week={{ next_week }}{% if show_all %}&show_all=1{% endif %}">Наступний ›</a>
        </div>
        <a href="{% url 'exchange_create' %}" class="btn btn-accent">Обмін змінами</a>
      </div>
    </div>
  </div>

  <div class="d-flex justify-content-end gap-2 flex-wrap align-items-center">
    {% if current_agent %}
      {% if show_all %}
        <a href="?{% for key, value in request.GET.items %}{% if key != 'show_all' %}{{ key }}={{ value|urlencode }}&{% endif %}{% endfor %}"
           class="btn btn-soft btn-sm schedule-filter__toggle">
          Показати тільки мене
        </a>
      {% else %}
        <a href="?{% for key, value in request.GET.items %}{% if key != 'show_all' %}{{ key }}={{ value|urlencode }}&{% endif %}{% endfor %}show_all=1"
           class="btn btn-soft btn-sm schedule-filter__toggle">
          Показати усіх агентів
        </a>
      {% endif %}
    {% endif %}
    <button class="btn btn-soft btn-sm schedule-filter__toggle" type="button" data-bs-toggle="collapse" data-bs-target="#filtersCollapse" aria-expanded="false" aria-controls="filtersCollapse">
      Фільтри
    </button>
  </div>

  <div class="collapse" id="filtersCollapse">
    <div class="card glass-card filters-card mb-4">
      <div class="card-body">
        <form method="get" class="row g-3 align-items-end">
          <input type="hidden" name="week" value="{{ request.GET.week|default:week_param }}">
          {% if show_all %}<input type="hidden" name="show_all" value="1">{% endif %}
          <div class="col-12">
            <div class="row g-3">
              {% crispy filter.form %}
            </div>
          </div>
          <div class="col-12 d-flex flex-wrap gap-2">
            <button type="submit" class="btn btn-accent">Застосувати</button>
            <a href="{% url 'schedule_week' %}?week={{ week_param }}" class="btn btn-soft">Скинути</a>
          </div>
        </form>
      </div>
    </div>
  </div>

  <div class="schedule-table-wrapper card glass-card">
    <div class="table-responsive">
      <table class="table table-modern align-middle schedule-table mb-0">
        <thead>
          <tr>
            <th scope="col">Агент</th>
            {% for d in days %}
              <th scope="col" class="text-center">
                <span class="schedule-table__day-name">{{ d|date:"D" }}</span>
                <span class="schedule-table__day-date">{{ d|date:"d.m" }}</span>
              </th>
            {% endfor %}
          </tr>
        </thead>
        <tbody>
          {% for row in table %}
            <tr>
              <td>
                <div class="agent-card">
                  <span class="agent-card__name">
                    {{ row.agent.user.get_full_name|default:row.agent.user.username }}
                  </span>
                  {% if row.agent.team_lead %}
                    <span class="agent-card__meta">
                      TL: {{ row.agent.team_lead.get_full_name|default:row.agent.team_lead.username }}
                    </span>
                  {% endif %}
                </div>
              </td>

              {% for shifts in row.cells %}
                <td class="shift-cell" data-agent-id="{{ row.agent.id }}" data-day-index="{{ forloop.counter0 }}" data-week-start="{{ week_start|date:'Y-m-d' }}">
                  {% if shifts %}
                    <div class="shift-stack">
                      {% for s in shifts %}
                        {% if s.status == 'sick' or s.status == 'vacation' or s.status == 'day_off' %}
                          <div class="shift-card shift-card--status"
                               data-shift-id="{{ s.id }}"
                               data-status="{{ s.status }}"
                               data-direction="{{ s.direction }}"
                               data-start-hm="{{ s.start|fmt_time }}"
                               data-end-hm="{{ s.end|fmt_time }}"
                               data-comment="{{ s.comment|default_if_none:''|escape }}">
                            {{ s.status_label }}{% if s.comment %} · {{ s.comment }}{% endif %}
                          </div>
                        {% elif s.status == 'work' %}
                          <div class="shift-card shift-card--work"
                               data-shift-id="{{ s.id }}"
                               data-status="{{ s.status }}"
                               data-direction="{{ s.direction }}"
                               data-start-hm="{{ s.start|fmt_time }}"
                               data-end-hm="{{ s.end|fmt_time }}"
                               data-comment="{{ s.comment|default_if_none:''|escape }}">
                            <span class="shift-card__direction">{{ s.direction_label }}</span>
                            <span class="shift-card__time">{{ s.start|fmt_time }}–{{ s.end|fmt_time }}</span>
                            {% if s.comment %}<span class="shift-card__meta">{{ s.comment }}</span>{% endif %}
                          </div>
                        {% elif s.status == 'mentor' %}
                          <div class="shift-card shift-card--other"
                               data-shift-id="{{ s.id }}"
                               data-status="{{ s.status }}"
                               data-direction="{{ s.direction }}"
                               data-start-hm="{{ s.start|fmt_time }}"
                               data-end-hm="{{ s.end|fmt_time }}"
                               data-comment="{{ s.comment|default_if_none:''|escape }}">
                            <span class="shift-card__direction">{{ s.status_label }}</span>
                            <span class="shift-card__time">{{ s.start|fmt_time }}–{{ s.end|fmt_time }}</span>
                            {% if s.comment %}<span class="shift-card__meta">{{ s.comment }}</span>{% endif %}
                          </div>
                        {% elif s.status == 'training' or s.status == 'meeting' or s.status == 'onboard' %}
                          <div class="shift-card shift-card--work"
                               data-shift-id="{{ s.id }}"
                               data-status="{{ s.status }}"
                               data-direction="{{ s.direction }}"
                               data-start-hm="{{ s.start|fmt_time }}"
                               data-end-hm="{{ s.end|fmt_time }}"
                               data-comment="{{ s.comment|default_if_none:''|escape }}">
                            <span class="shift-card__direction">{{ s.status_label }}</span>
                            <span class="shift-card__time">{{ s.start|fmt_time }}–{{ s.end|fmt_time }}</span>
                            {% if s.comment %}<span class="shift-card__meta">{{ s.comment }}</span>{% endif %}
                          </div>
                        {% else %}
                          <div class="shift-card shift-card--other"
                               data-shift-id="{{ s.id }}"
                               data-status="{{ s.status }}"
                               data-direction="{{ s.direction }}"
                               data-start-hm="{{ s.start|fmt_time }}"
                               data-end-hm="{{ s.end|fmt_time }}"
                               data-comment="{{ s.comment|default_if_none:''|escape }}">
                            <span class="shift-card__direction">{{ s.direction_label }}</span>
                            <span class="shift-card__time">{{ s.start|fmt_time }}–{{ s.end|fmt_time }}</span>
                            <span class="shift-card__meta">{{ s.status_label }}{% if s.comment %} · {{ s.comment }}{% endif %}</span>
                          </div>
                        {% endif %}
                      {% endfor %}
                    </div>
                  {% else %}
                    <div class="shift-empty" role="button" tabindex="0">Немає змін</div>
                  {% endif %}
                </td>
              {% endfor %}
            </tr>
          {% empty %}
            <tr>
              <td colspan="{{ days|length|add:'1' }}" class="text-center text-muted py-5">Нічого не знайдено за цими фільтрами.</td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>

</div>

<!-- Context menu for shifts -->
<div id="shiftContextMenu" class="shift-menu">
  <button class="shift-menu__item" type="button" data-action="edit">
    Редагувати зміну…
  </button>
  <button class="shift-menu__item" type="button" data-action="add_hours">
    Додати години…
  </button>
  <!-- Future quick actions can be added here -->
  <button class="shift-menu__item text-danger" type="button" data-action="close">
    Закрити
  </button>
</div>

<!-- Edit Shift Modal -->
<div class="modal fade" id="editShiftModal" tabindex="-1" aria-labelledby="editShiftLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="editShiftLabel">Редагувати зміну</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form id="editShiftForm">
          <input type="hidden" name="shift_id" id="editShiftId">
          <div class="row g-3">
            <div class="col-6">
              <label for="editShiftStartTime" class="form-label">Початок</label>
              <input type="text" id="editShiftStartTime" name="start_time"
                     class="form-control" list="hhmmList" placeholder="HH:MM" autocomplete="off">
            </div>
            <div class="col-6">
              <label for="editShiftEndTime" class="form-label">Завершення</label>
              <input type="text" id="editShiftEndTime" name="end_time"
                     class="form-control" list="hhmmList" placeholder="HH:MM" autocomplete="off">
            </div>
            <div class="col-6">
              <label for="editShiftStatus" class="form-label">Статус</label>
              <select id="editShiftStatus" name="status" class="form-select" data-no-enhance="1">
                {% for key,label in status_choices %}
                  <option value="{{ key }}">{{ label }}</option>
                {% endfor %}
              </select>
            </div>
            <div class="col-6">
              <label for="editShiftDirection" class="form-label">Напрямок</label>
              <select id="editShiftDirection" name="direction" class="form-select" data-no-enhance="1">
                {% for key,label in direction_choices %}
                  <option value="{{ key }}">{{ label }}</option>
                {% endfor %}
              </select>
            </div>
            <div class="col-12">
              <label for="editShiftComment" class="form-label">Коментар</label>
              <textarea class="form-control" id="editShiftComment" name="comment" rows="2"></textarea>
            </div>
          </div>
        </form>
        <div class="alert alert-danger d-none mt-3" id="editShiftError"></div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-outline-danger me-auto" id="deleteShiftBtn">Видалити</button>
        <button type="button" class="btn btn-soft" data-bs-dismiss="modal">Скасувати</button>
        <button type="button" class="btn btn-accent" id="saveShiftBtn">Зберегти</button>
      </div>
    </div>
  </div>
  </div>

<!-- Common suggestions for time inputs -->
<datalist id="hhmmList">
  {% for h in hours %}
    <option value="{{ h }}:00"></option>
  {% endfor %}
  <option value="00:30"></option>
  <option value="12:30"></option>
  <option value="18:30"></option>
  <option value="23:30"></option>
  <!-- 24:00 allowed only for end time -->
  <option value="24:00"></option>
  <!-- Users can type any HH:MM like 14:17 -->
  
</datalist>

<!-- Add Hours Modal -->
<div class="modal fade" id="addHoursModal" tabindex="-1" aria-labelledby="addHoursLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="addHoursLabel">Додати години</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form id="addHoursForm">
          <input type="hidden" id="addHoursBaseShiftId">
          <input type="hidden" id="addHoursAgentId">
          <input type="hidden" id="addHoursDate">
          <div class="row g-3">
            <div class="col-6">
              <label for="addHoursStartTime" class="form-label">Початок</label>
              <input type="text" id="addHoursStartTime" name="start_time"
                     class="form-control" list="hhmmList" placeholder="HH:MM" autocomplete="off">
            </div>
            <div class="col-6">
              <label for="addHoursEndTime" class="form-label">Завершення</label>
              <input type="text" id="addHoursEndTime" name="end_time"
                     class="form-control" list="hhmmList" placeholder="HH:MM" autocomplete="off">
            </div>
            <div class="col-6">
              <label for="addHoursStatus" class="form-label">Статус</label>
              <select id="addHoursStatus" name="status" class="form-select" data-no-enhance="1">
                {% for key,label in status_choices %}
                  <option value="{{ key }}">{{ label }}</option>
                {% endfor %}
              </select>
            </div>
            <div class="col-6">
              <label for="addHoursDirection" class="form-label">Напрямок</label>
              <select id="addHoursDirection" name="direction" class="form-select" data-no-enhance="1">
                {% for key,label in direction_choices %}
                  <option value="{{ key }}">{{ label }}</option>
                {% endfor %}
              </select>
            </div>
            <div class="col-12">
              <label for="addHoursComment" class="form-label">Коментар</label>
              <textarea class="form-control" id="addHoursComment" name="comment" rows="2"></textarea>
            </div>
          </div>
        </form>
        <div class="alert alert-danger d-none mt-3" id="addHoursError"></div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-soft" data-bs-dismiss="modal">Скасувати</button>
        <button type="button" class="btn btn-accent" id="saveAddHoursBtn">Додати</button>
      </div>
    </div>
  </div>
  </div>

<script>
document.addEventListener('shown.bs.dropdown', function (e) {
  if (e.target && e.target.nextElementSibling && e.target.nextElementSibling.id === 'weeksDropdown') {
    const menu = e.target.nextElementSibling;
    const active = menu.querySelector('.dropdown-item.active');
    if (active) {
      const top = active.offsetTop - menu.clientHeight / 2 + active.clientHeight / 2;
      menu.scrollTop = Math.max(top, 0);
    }
  }
}, true);
</script>

<script>
// Right-click context menu and edit modal logic
document.addEventListener('DOMContentLoaded', function () {
  const menu = document.getElementById('shiftContextMenu');
  const editModalEl = document.getElementById('editShiftModal');

  if (!menu || !editModalEl) {
    return;
  }

  const bootstrapLib = window.bootstrap || (typeof bootstrap !== 'undefined' ? bootstrap : null);
  const hasBootstrapModal = !!(bootstrapLib && bootstrapLib.Modal);
  const editModal = hasBootstrapModal ? bootstrapLib.Modal.getOrCreateInstance(editModalEl) : null;
  const addModalEl = document.getElementById('addHoursModal');
  const addModal = (hasBootstrapModal && addModalEl) ? bootstrapLib.Modal.getOrCreateInstance(addModalEl) : null;
  let fallbackBackdrop = null;

  function openEditModal() {
    if (hasBootstrapModal && editModal) {
      editModal.show();
      return;
    }
    if (!fallbackBackdrop) {
      fallbackBackdrop = document.createElement('div');
      fallbackBackdrop.className = 'modal-backdrop fade show';
      document.body.appendChild(fallbackBackdrop);
    }
    editModalEl.classList.add('show');
    editModalEl.style.display = 'block';
    editModalEl.removeAttribute('aria-hidden');
    editModalEl.setAttribute('aria-modal', 'true');
    document.body.classList.add('modal-open');
  }

  function closeEditModal() {
    if (hasBootstrapModal && editModal) {
      editModal.hide();
      return;
    }
    editModalEl.classList.remove('show');
    editModalEl.style.display = 'none';
    editModalEl.setAttribute('aria-hidden', 'true');
    editModalEl.removeAttribute('aria-modal');
    if (fallbackBackdrop) {
      fallbackBackdrop.remove();
      fallbackBackdrop = null;
    }
    document.body.classList.remove('modal-open');
  }

  editModalEl.querySelectorAll('[data-bs-dismiss="modal"]').forEach((btn) => {
    btn.addEventListener('click', function () {
      if (!hasBootstrapModal) {
        closeEditModal();
      }
    });
  });

  editModalEl.addEventListener('click', function (evt) {
    if (!hasBootstrapModal && evt.target === editModalEl) {
      closeEditModal();
    }
  });

  document.addEventListener('keydown', function (evt) {
    if (!hasBootstrapModal) {
      const isOpen = editModalEl.classList.contains('show');
      if (isOpen && evt.key === 'Escape') {
        closeEditModal();
      }
    }
  });
  const saveBtn = document.getElementById('saveShiftBtn');
  const deleteBtn = document.getElementById('deleteShiftBtn');
  const form = document.getElementById('editShiftForm');
  const errBox = document.getElementById('editShiftError');
  const addSaveBtn = document.getElementById('saveAddHoursBtn');
  const addErrBox = document.getElementById('addHoursError');
  const addForm = document.getElementById('addHoursForm');
  // Click on empty cell to add a new shift
  document.addEventListener('click', function (e) {
    const empty = e.target.closest('.shift-empty');
    if (!empty) return;
    const cell = empty.closest('td.shift-cell');
    if (!cell || !addModal) return;
    const agentId = cell.getAttribute('data-agent-id') || '';
    const idxStr = cell.getAttribute('data-day-index') || '0';
    const weekStart = cell.getAttribute('data-week-start') || '';

    const idx = parseInt(idxStr, 10) || 0;
    let date = new Date(weekStart + 'T00:00:00');
    if (!isNaN(idx)) { date.setDate(date.getDate() + idx); }
    const y = date.getFullYear();
    const m = String(date.getMonth() + 1).padStart(2, '0');
    const d = String(date.getDate()).padStart(2, '0');
    const dateIso = `${y}-${m}-${d}`;

    document.getElementById('addHoursBaseShiftId').value = '';
    document.getElementById('addHoursAgentId').value = agentId;
    document.getElementById('addHoursDate').value = dateIso;

    // Reasonable defaults
    const addStartInput = document.getElementById('addHoursStartTime');
    const addEndInput = document.getElementById('addHoursEndTime');
    if (addStartInput) addStartInput.value = '09:00';
    if (addEndInput) addEndInput.value = '18:00';
    const addDirSel = document.getElementById('addHoursDirection');
    const addStatusSel = document.getElementById('addHoursStatus');
    if (addStatusSel) addStatusSel.value = 'work';
    // leave direction as default (first option)
    const comm = document.getElementById('addHoursComment');
    if (comm) comm.value = '';
    if (addErrBox) { addErrBox.classList.add('d-none'); addErrBox.textContent = ''; }
    addModal.show();
  });

  // hour suggestions via datalist; free typing is allowed

  function _padTime(val) {
    if (!val) return '';
    const m = String(val).trim().match(/^(\d{1,2})(?::(\d{1,2}))?$/);
    if (!m) return String(val).trim();
    let h = parseInt(m[1], 10);
    let mm = m[2] !== undefined ? parseInt(m[2], 10) : 0;
    if (isNaN(h) || isNaN(mm)) return String(val).trim();
    if (h < 0) h = 0; if (h > 24) h = 24;
    if (h === 24) mm = 0; // only 24:00 allowed
    if (mm < 0) mm = 0; if (mm > 59) mm = 59;
    return `${String(h).padStart(2,'0')}:${String(mm).padStart(2,'0')}`;
  }

  function fillFormFields(data) {
    if (!data) return;
    const mapping = [
      { id: 'editShiftId', key: 'id', transform: (v)=>v },
      { id: 'editShiftStatus', key: 'status', transform: (v)=>v },
      { id: 'editShiftDirection', key: 'direction', transform: (v)=>v },
      { id: 'editShiftStartTime', key: 'start_time', transform: _padTime },
      { id: 'editShiftEndTime', key: 'end_time', transform: _padTime },
      { id: 'editShiftComment', key: 'comment', transform: (v)=>v },
    ];
    for (const { id, key, transform } of mapping) {
      if (!Object.prototype.hasOwnProperty.call(data, key)) continue;
      const el = document.getElementById(id);
      if (!el) { console.warn('Shift editor: missing element #'+id); continue; }
      const raw = data[key];
      const val = transform ? transform(raw == null ? '' : String(raw)) : (raw == null ? '' : String(raw));
      el.value = val;
    }
  }

  async function fetchShiftDetails(shiftId) {
    const resp = await fetch(`/ajax/shift/${shiftId}/edit/`, {
      method: 'GET',
      headers: { 'Accept': 'application/json' },
      credentials: 'same-origin',
    });
    const payload = await resp.json().catch(() => ({}));
    if (!resp.ok || !payload.ok) {
      const msg = (payload && payload.error) ? payload.error : `Не вдалося отримати дані (${resp.status}).`;
      throw new Error(msg);
    }
    return payload.shift;
  }

  function hideMenu() {
    menu.style.display = 'none';
  }
  function showMenu(x, y) {
    const vw = window.innerWidth;
    const vh = window.innerHeight;
    const menuWidth = 260; // approx
    const menuHeight = 140; // approx
    const left = Math.max(8, Math.min(x, vw - menuWidth - 8));
    const top = Math.max(8, Math.min(y, vh - menuHeight - 8));
    menu.style.left = left + 'px';
    menu.style.top = top + 'px';
    menu.style.display = 'block';
  }
  function getCookie(name) {
    const value = `; ${document.cookie}`;
    const parts = value.split(`; ${name}=`);
    if (parts.length === 2) return parts.pop().split(';').shift();
  }

  // Ensure clicks inside the menu don't immediately propagate to document
  menu.addEventListener('mousedown', (e) => e.stopPropagation());
  menu.addEventListener('click', (e) => e.stopPropagation());
  document.addEventListener('click', hideMenu);
  document.addEventListener('scroll', hideMenu, true);
  // Fallback for environments where 'contextmenu' might be blocked
  document.addEventListener('mousedown', function (e) {
    if (e.button !== 2) return; // right button
    const card = e.target.closest('.shift-card[data-shift-id]');
    if (!card) return;
    e.preventDefault();
    const id = card.getAttribute('data-shift-id');
    menu.dataset.targetId = id;
    menu.dataset.initStatus = card.getAttribute('data-status') || '';
    menu.dataset.initDirection = card.getAttribute('data-direction') || '';
    menu.dataset.initStart = card.getAttribute('data-start-hm') || '';
    menu.dataset.initEnd = card.getAttribute('data-end-hm') || '';
    menu.dataset.initComment = card.getAttribute('data-comment') || '';
    if (menu.parentElement !== document.body) {
      document.body.appendChild(menu);
    }
    showMenu(e.clientX, e.clientY);
  });
  document.addEventListener('contextmenu', function (e) {
    const card = e.target.closest('.shift-card[data-shift-id]');
    if (!card) {
      hideMenu();
      return; // Let default context menu work elsewhere
    }
    e.preventDefault();
    const id = card.getAttribute('data-shift-id');
    menu.dataset.targetId = id;
    // store initial data for modal
    menu.dataset.initStatus = card.getAttribute('data-status') || '';
    menu.dataset.initDirection = card.getAttribute('data-direction') || '';
    menu.dataset.initStart = card.getAttribute('data-start-hm') || '';
    menu.dataset.initEnd = card.getAttribute('data-end-hm') || '';
    menu.dataset.initComment = card.getAttribute('data-comment') || '';

    // Move the menu under body to avoid overflow clipping
    if (menu.parentElement !== document.body) {
      document.body.appendChild(menu);
    }
    const x = e.clientX;
    const y = e.clientY;
    showMenu(x, y);
  });

  // Optional usability: double‑click a shift to edit directly
  document.addEventListener('dblclick', function (e) {
    const card = e.target.closest('.shift-card[data-shift-id]');
    if (!card) return;
    const id = card.getAttribute('data-shift-id');
    // Pre-fill from dataset first
    fillFormFields({
      id,
      status: card.getAttribute('data-status') || '',
      direction: card.getAttribute('data-direction') || '',
      start_time: card.getAttribute('data-start-hm') || '',
      end_time: card.getAttribute('data-end-hm') || '',
      comment: card.getAttribute('data-comment') || '',
    });
    errBox.classList.add('d-none');
    errBox.textContent = '';
    openEditModal();
    saveBtn.disabled = true;
    fetchShiftDetails(id)
      .then((data) => {
        fillFormFields(data);
        errBox.classList.add('d-none');
        errBox.textContent = '';
      })
      .catch((err) => {
        errBox.textContent = err.message || 'Не вдалося отримати актуальні дані зміни.';
        errBox.classList.remove('d-none');
      })
      .finally(() => {
        saveBtn.disabled = false;
      });
  });

  menu.addEventListener('click', function (e) {
    const btn = e.target.closest('[data-action]');
    if (!btn) return;
    const action = btn.getAttribute('data-action');
    if (action === 'edit') {
      e.preventDefault();
      e.stopPropagation();
      hideMenu();
      const fallbackData = {
        id: menu.dataset.targetId || '',
        status: menu.dataset.initStatus || '',
        direction: menu.dataset.initDirection || '',
        start_time: menu.dataset.initStart || '',
        end_time: menu.dataset.initEnd || '',
        
        comment: menu.dataset.initComment || '',
      };
      fillFormFields(fallbackData);
      errBox.classList.add('d-none');
      errBox.textContent = '';
      openEditModal();
      saveBtn.disabled = true;
      fetchShiftDetails(fallbackData.id)
        .then((data) => {
          fillFormFields(data);
          errBox.classList.add('d-none');
          errBox.textContent = '';
        })
        .catch((err) => {
          errBox.textContent = err.message || 'Не вдалося отримати актуальні дані зміни.';
          errBox.classList.remove('d-none');
        })
        .finally(() => {
          saveBtn.disabled = false;
        });
    } else if (action === 'add_hours') {
      e.preventDefault();
      e.stopPropagation();
      hideMenu();
      if (!addModal) return;
      const baseId = menu.dataset.targetId || '';
      document.getElementById('addHoursBaseShiftId').value = baseId;
      const startHH = (menu.dataset.initStart || '').trim();
      const endHH = (menu.dataset.initEnd || '').trim();
      const dir = menu.dataset.initDirection || '';
      // Defaults
      const addStartInput = document.getElementById('addHoursStartTime');
      const addEndInput = document.getElementById('addHoursEndTime');
      if (addStartInput) addStartInput.value = startHH || '00:00';
      if (addEndInput) addEndInput.value = endHH || '01:00';
      const addDirSel = document.getElementById('addHoursDirection');
      const addStatusSel = document.getElementById('addHoursStatus');
      if (addDirSel) addDirSel.value = dir;
      if (addStatusSel) addStatusSel.value = 'work';
      const comm = document.getElementById('addHoursComment');
      if (comm) comm.value = '';
      if (addErrBox) { addErrBox.classList.add('d-none'); addErrBox.textContent = ''; }
      addModal.show();
    } else if (action === 'close') {
      hideMenu();
    }
  });

  saveBtn.addEventListener('click', async function () {
    const getVal = (id) => {
      const el = document.getElementById(id);
      return el ? el.value : '';
    };
    const shiftId = getVal('editShiftId');
    const payload = {
      status: getVal('editShiftStatus'),
      direction: getVal('editShiftDirection'),
      start_time: _padTime(getVal('editShiftStartTime')),
      end_time: _padTime(getVal('editShiftEndTime')),
      comment: getVal('editShiftComment'),
    };
    saveBtn.disabled = true;

    try {
      const resp = await fetch(`/ajax/shift/${shiftId}/edit/`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': getCookie('csrftoken') || '',
        },
        credentials: 'same-origin',
        body: JSON.stringify(payload),
      });
      const data = await resp.json().catch(() => ({}));
      if (!resp.ok || !data.ok) {
        const msg = (data && data.error) ? data.error : `Помилка збереження (${resp.status})`;
        throw new Error(msg);
      }
      // Reload to reflect updates
      window.location.reload();
    } catch (err) {
      errBox.textContent = err.message || 'Не вдалося зберегти зміну.';
      errBox.classList.remove('d-none');
    } finally {
      saveBtn.disabled = false;
    }
  });

  // Delete shift handler
  if (deleteBtn) {
    deleteBtn.addEventListener('click', async function () {
      const idEl = document.getElementById('editShiftId');
      const shiftId = idEl ? idEl.value : '';
      if (!shiftId) {
        errBox.textContent = 'Невідомий ідентифікатор зміни.';
        errBox.classList.remove('d-none');
        return;
      }
      const proceed = window.confirm('Видалити цю зміну? Дію неможливо скасувати.');
      if (!proceed) return;
      deleteBtn.disabled = true;
      try {
        const resp = await fetch(`/ajax/shift/${shiftId}/delete/`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken') || '',
          },
          credentials: 'same-origin',
          body: JSON.stringify({}),
        });
        const data = await resp.json().catch(() => ({}));
        if (!resp.ok || !data.ok) {
          const msg = (data && data.error) ? data.error : `Помилка видалення (${resp.status})`;
          throw new Error(msg);
        }
        window.location.reload();
      } catch (err) {
        errBox.textContent = err.message || 'Не вдалося видалити зміну.';
        errBox.classList.remove('d-none');
      } finally {
        deleteBtn.disabled = false;
      }
    });
  }
  if (addSaveBtn) {
    addSaveBtn.addEventListener('click', async function () {
      const getVal = (id) => { const el = document.getElementById(id); return el ? el.value : ''; };
      const baseId = getVal('addHoursBaseShiftId');
      const payload = {
        start_time: _padTime(getVal('addHoursStartTime')),
        end_time: _padTime(getVal('addHoursEndTime')),
        status: getVal('addHoursStatus'),
        direction: getVal('addHoursDirection'),
        comment: getVal('addHoursComment'),
      };
      addSaveBtn.disabled = true;
      try {
        let url = '';
        let body = null;
        if (baseId) {
          url = `/ajax/shift/${baseId}/add-hours/`;
          body = JSON.stringify(payload);
        } else {
          // create a brand new shift
          url = `/ajax/shift/create/`;
          body = JSON.stringify({
            agent_id: getVal('addHoursAgentId'),
            date: getVal('addHoursDate'),
            ...payload,
          });
        }
        const resp = await fetch(url, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', 'X-CSRFToken': getCookie('csrftoken') || '' },
          credentials: 'same-origin',
          body,
        });
        const data = await resp.json().catch(() => ({}));
        if (!resp.ok || !data.ok) {
          const msg = (data && data.error) ? data.error : `Помилка збереження (${resp.status})`;
          throw new Error(msg);
        }
        window.location.reload();
      } catch (err) {
        if (addErrBox) { addErrBox.textContent = err.message || 'Не вдалося додати години.'; addErrBox.classList.remove('d-none'); }
      } finally {
        addSaveBtn.disabled = false;
      }
    });
  }
});
</script>

{% endblock %}
